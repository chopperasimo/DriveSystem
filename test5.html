<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex,nofollow">
<title>GPS軌跡・距離計測（地理院地図・JST）</title>

<!-- OpenLayers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@9.0.0/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@9.0.0/dist/ol.js"></script>

<style>
body {
    margin: 0;
    font-family: sans-serif;
}
#map {
    width: 100%;
    height: 70vh;
}
#info {
    padding: 10px;
}
button {
    padding: 6px 12px;
    margin-right: 6px;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="info">
    <div>取得回数：<span id="count">0</span></div>
    <div>緯度：<span id="lat">---</span></div>
    <div>経度：<span id="lng">---</span></div>
    <div>累積移動距離：<span id="distance">0</span> m</div>
    <br>
    <button onclick="start()">計測開始</button>
    <button onclick="stop()">停止</button>
    <button onclick="saveTxt()">TXT保存</button>
</div>

<script>
// =====================
// JST時刻生成
// =====================
function getJSTString() {
    const now = new Date();
    const jst = new Date(now.getTime() + 9 * 60 * 60 * 1000);

    const y = jst.getUTCFullYear();
    const m = String(jst.getUTCMonth() + 1).padStart(2, '0');
    const d = String(jst.getUTCDate()).padStart(2, '0');
    const h = String(jst.getUTCHours()).padStart(2, '0');
    const min = String(jst.getUTCMinutes()).padStart(2, '0');
    const s = String(jst.getUTCSeconds()).padStart(2, '0');

    return `${y}-${m}-${d} ${h}:${min}:${s}`;
}

function getJSTFileName() {
    const now = new Date();
    const jst = new Date(now.getTime() + 9 * 60 * 60 * 1000);

    const y = jst.getUTCFullYear();
    const m = String(jst.getUTCMonth() + 1).padStart(2, '0');
    const d = String(jst.getUTCDate()).padStart(2, '0');
    const h = String(jst.getUTCHours()).padStart(2, '0');
    const min = String(jst.getUTCMinutes()).padStart(2, '0');
    const s = String(jst.getUTCSeconds()).padStart(2, '0');

    return `${y}${m}${d}_${h}${min}${s}`;
}

// =====================
// 地図初期化（地理院地図）
// =====================
const map = new ol.Map({
    target: 'map',
    layers: [
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
                attributions: '地理院タイル'
            })
        })
    ],
    view: new ol.View({
        center: ol.proj.fromLonLat([139.691686, 35.689481]),
        zoom: 18
    })
});

// マーカー・軌跡
const positionFeature = new ol.Feature();
const pathFeature = new ol.Feature(new ol.geom.LineString([]));

const vectorLayer = new ol.layer.Vector({
    source: new ol.source.Vector({
        features: [pathFeature, positionFeature]
    }),
    style: feature => {
        if (feature === positionFeature) {
            return new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 6,
                    fill: new ol.style.Fill({ color: 'red' })
                })
            });
        } else {
            return new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'blue',
                    width: 3
                })
            });
        }
    }
});
map.addLayer(vectorLayer);

// =====================
// GPS・距離計算
// =====================
let timer = null;
let prevPos = null;
let totalDistance = 0;
let count = 0;
let logData = [];

const R = 6371000;

function calcDistance(lat1, lon1, lat2, lon2) {
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function getPosition() {
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const time = getJSTString();

        if (prevPos) {
            totalDistance += calcDistance(
                prevPos.lat, prevPos.lon, lat, lon
            );
        }

        prevPos = { lat, lon };
        count++;

        document.getElementById('lat').textContent = lat.toFixed(6);
        document.getElementById('lng').textContent = lon.toFixed(6);
        document.getElementById('distance').textContent = totalDistance.toFixed(2);
        document.getElementById('count').textContent = count;

        const coord = ol.proj.fromLonLat([lon, lat]);
        positionFeature.setGeometry(new ol.geom.Point(coord));
        pathFeature.getGeometry().appendCoordinate(coord);
        map.getView().setCenter(coord);

        logData.push(
            `${time},${lat.toFixed(6)},${lon.toFixed(6)},${totalDistance.toFixed(2)}`
        );
    });
}

function start() {
    if (timer) return;
    getPosition();
    timer = setInterval(getPosition, 2500);
}

function stop() {
    if (timer) {
        clearInterval(timer);
        timer = null;
    }
}

// =====================
// TXT保存
// =====================
function saveTxt() {
    if (logData.length === 0) {
        alert("データがありません");
        return;
    }

    const header = "time,latitude,longitude,total_distance_m\n";
    const text = header + logData.join("\n");

    const blob = new Blob([text], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `gps_log_${getJSTFileName()}.txt`;
    a.click();

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
